<ul class="list-group mb-4" id="sysinfo-list">
<!-- Filled dynamically -->
</ul>

<div class="mb-5">
<canvas id="chart" height="100"></canvas>
</div>

<script>
  let MAX_POINTS = 30;
  const chart = new Chart(document.getElementById('chart').getContext('2d'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: "CPU %",
          data: [],
          borderColor: "rgba(54, 162, 235, 1)",
          backgroundColor: "rgba(54, 162, 235, 0.2)",
          borderWidth: 2,
          tension: 0.3
        },
        {
          label: "Memory %",
          data: [],
          borderColor: "rgba(255, 206, 86, 1)",
          backgroundColor: "rgba(255, 206, 86, 0.2)",
          borderWidth: 2,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      animation: false,
      scales: {
        y: {
          min: 0,
          max: 100
        }
      }
    }
  });

  async function loadInfo() {
    try {
      const res = await safeFetch("/system/api?_=" + Date.now());
      const data = await res.json();

      // Populate list group
      const list = document.getElementById("sysinfo-list");
      list.innerHTML = `
        <li class="list-group-item">IP Address: ${data.ip_address}</li>
        <li class="list-group-item">MAC Address: ${data.mac_address}</li>
        <li class="list-group-item">CPU Usage: ${data.cpu_percent}%</li>

        <li class="list-group-item">
          Memory: ${data.memory_used}MB / ${data.memory_total}MB (${data.memory_percent}%)
          <div class="progress mt-1">
            <div class="progress-bar bg-info" role="progressbar" style="width: ${data.memory_percent}%">
              ${data.memory_percent}%
            </div>
          </div>
        </li>

        <li class="list-group-item">
          Disk: ${data.disk_used}GB / ${data.disk_total}GB (${data.disk_percent}%)
          <div class="progress mt-1">
            <div class="progress-bar bg-warning" role="progressbar" style="width: ${data.disk_percent}%">
              ${data.disk_percent}%
            </div>
          </div>
        </li>

        <li class="list-group-item">Load Avg (1/5/15 min): ${data.load_avg.join(", ")}</li>
        <li class="list-group-item">Uptime: ${formatUptime(data.uptime)}</li>
        <li class="list-group-item">Platform: ${data.platform}</li>
      `;

      updateChart(data.cpu_percent, data.memory_percent);
    } catch (err) {
      // alert("Error fetching system info: " + err);
      console.error("Error fetching system info:", err.message);
      showFetchErrorOnce();
    }
  }

  function formatUptime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return `${h}h ${m}m`;
  }

  let timeCounter = 0;

  function updateChart(cpu, mem) {
    const labels = chart.data.labels;
    const cpuData = chart.data.datasets[0].data;
    const memData = chart.data.datasets[1].data;

    if (labels.length >= MAX_POINTS) {
      labels.shift();
      cpuData.shift();
      memData.shift();
    }

    labels.push(timeCounter.toString());
    cpuData.push(cpu);
    memData.push(mem);

    timeCounter++;
    chart.update();
  }

  loadInfo();
  dataFetchTimers.push(setInterval(loadInfo, 5000));

</script>
